# SBOM Generation - Software Bill of Materials
# Generates CycloneDX SBOM for FDA compliance
# Reference: FDA Cybersecurity Guidance 2025

name: SBOM Generation

on:
  push:
    branches: [main]
    paths:
      - "pyproject.toml"
      - "uv.lock"
      - "requirements*.txt"
  release:
    types: [published]
  # Run weekly on Wednesday at 3 AM
  schedule:
    - cron: "0 3 * * 3"
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.11"

jobs:
  # ===========================================================================
  # Generate CycloneDX SBOM
  # ===========================================================================
  generate-sbom:
    name: Generate SBOM (CycloneDX)
    runs-on: ubuntu-latest
    permissions:
      contents: write
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install UV
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Install dependencies
        run: |
          uv sync
          uv pip install cyclonedx-bom

      - name: Generate CycloneDX SBOM (JSON)
        run: |
          uv run cyclonedx-py environment \
            --output-format json \
            --output-file sbom.cdx.json \
            --mc-type application \
            --author "MedTech AI Security" \
            --component-version "${{ github.ref_name }}"

      - name: Generate CycloneDX SBOM (XML)
        run: |
          uv run cyclonedx-py environment \
            --output-format xml \
            --output-file sbom.cdx.xml \
            --mc-type application \
            --author "MedTech AI Security" \
            --component-version "${{ github.ref_name }}"

      - name: Validate SBOM
        run: |
          # Install sbom-utility for validation
          curl -sL https://github.com/CycloneDX/sbom-utility/releases/download/v0.16.0/sbom-utility-v0.16.0-linux-amd64.tar.gz | tar xz
          ./sbom-utility validate --input-file sbom.cdx.json

      - name: Upload SBOM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sbom-${{ github.sha }}
          path: |
            sbom.cdx.json
            sbom.cdx.xml
          retention-days: 90

      - name: Upload SBOM to release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: |
            sbom.cdx.json
            sbom.cdx.xml

  # ===========================================================================
  # Dependency Vulnerability Scan
  # ===========================================================================
  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    needs: generate-sbom
    permissions:
      security-events: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download SBOM artifact
        uses: actions/download-artifact@v4
        with:
          name: sbom-${{ github.sha }}

      - name: Run Grype vulnerability scan
        uses: anchore/scan-action@v4
        id: grype-scan
        with:
          sbom: sbom.cdx.json
          fail-build: false
          severity-cutoff: high
          output-format: sarif

      - name: Upload Grype SARIF results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: ${{ steps.grype-scan.outputs.sarif }}
          category: grype-dependencies

  # ===========================================================================
  # License Compliance Check
  # ===========================================================================
  license-check:
    name: License Compliance
    runs-on: ubuntu-latest
    needs: generate-sbom

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download SBOM artifact
        uses: actions/download-artifact@v4
        with:
          name: sbom-${{ github.sha }}

      - name: Check license compliance
        run: |
          # Install jq for JSON parsing
          sudo apt-get install -y jq

          # Extract licenses from SBOM
          echo "=== License Summary ==="
          jq -r '.components[].licenses[]?.license.id // "Unknown"' sbom.cdx.json | sort | uniq -c | sort -rn

          # Check for problematic licenses
          echo ""
          echo "=== Checking for restricted licenses ==="
          RESTRICTED_LICENSES="GPL-3.0|AGPL|SSPL|Commons-Clause"
          if jq -r '.components[].licenses[]?.license.id // empty' sbom.cdx.json | grep -E "$RESTRICTED_LICENSES"; then
            echo "[WARN] Found potentially restricted licenses - manual review recommended"
          else
            echo "[OK] No restricted licenses found"
          fi
